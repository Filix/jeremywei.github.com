---
layout: post
title: DNS反向查询(Reverse lookup)
---

<p><strong>什么是反向查询</strong></p>

<p>众所周知，互联网通过DNS来查找一个域名的IP地址，这个被称为正向DNS查询。反向DNS查询是用来确定一个 IP地址所对应的域名。互联网上反向DNS的数据存放在arpa(Address and Routing Parameter Area) 这个顶 级域名下面。IPv4使用in-addr.arpa这个域，IPv6使用ip6.arpa这个域。反向DNS查询是通过查询<a href="http://en.wikipedia.org/wiki/PTR_record#PTR" target="_blank">PTR</a>记录来 完成。互联网的标准文档(RFC 1033, RFC 1912 Section 2.1)指出互联网上每个主机都应该有个名字，这个名 字就是在PTR记录中指定的。</p>

<p><strong>反向查询流程</strong></p>

<p>如果对IPv4的地址进行反向DNS查询的话，<a href="http://en.wikipedia.org/wiki/Resolver_%28DNS%29#DNS_resolvers" target="_blank">resolver</a>首先会把这个IPv4的地址转换成一个特殊的域名，这个域名 的生成规则是把ip地址的4个8位的数字进行倒序排列，即最左边的数字放在最右边，然后把这个字符序列作为域 名&#8217;.in-addr.arpa&#8217;的子域名。然后，resolver再去查询这个域名的PTR记录，从而得到这个IP的信息。</p>

<p>例如，假设mail.example.com会指向192.0.2.5这个IP地址，并且也给IP192.0.2.5添加了PTR记录，即</p>

<pre>5.2.0.192.in-addr.arpa PTR mail.example.com </pre>

<p>那么如果要对192.0.2.5进行反向DNS查询，首先根据规则要把192.0.2.5这个IP地址转换成 &#8220;5.2.0.192.in-addr.arpa&#8221;这个域名，然后去查询这个域名的PTR记录，从而得到这个IP地址的信息。</p>

<p>如果对IPv6地址进行反向DNS查询，那么也需要把IPv6地址转换成一个域名，规则是把IP地址转换成<a href="http://en.wikipedia.org/wiki/Nibble" target="_blank">nibbles</a> 形式的字串，并进行倒序处理，之后把这个字符串和ip6.arpa域名拼接在一起，组成一个新域名，然后去查询这个 域名的PTR记录。 例如，要对2001:db8::567:89ab进行反向DNS解析，那么根据规则需要把IP转换为 b.a.9.8.7.6.5.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.8.b.d.0.1.0.0.2.ip6.arpa， 然后去查询这个域的PTR记录。</p>

<p><strong>使用场景</strong></p>

<p>1. 一些故障处理工具会进行反向查询，比如traceroute，ping，或者SMTP中的&#8221;Received:&#8221;头。</p>

<p>2. 反垃圾邮件技术：通过反向查询可以知道这个IP是不是动态IP，动态IP通过进行反向查询之后一般返回的名字是 &#8220;1-2-3-4-dynamic-ip.example.com.&#8221;这种格式的字符串，很多反垃圾邮件过滤器都会拒绝这类IP发送的邮件。</p>

<p>3. 系统日志和监控工具会把一些IP的记录转换成用户友好的形式，这个需要反向查询，比如服务器的访问日志中会 有google,baidu等搜索引擎的爬虫记录，通过反向查询可以使人很直观的知道google和baidu的访问情况。</p>

<p><strong>反向查询例子</strong></p>

<pre>dig -x 208.80.152.2

2.152.80.208.in-addr.arpa. 3577 IN      PTR     rr.pmtpa.wikimedia.org.

</pre>

<p><strong>备注</strong></p>

<p>PTR记录需要ISP来做，自己无法添加，因为你的IP是ISP所控制的。</p>

<p>参考：<br/> <a href="http://en.wikipedia.org/wiki/Reverse_DNS_lookup" target="_blank">http://en.wikipedia.org/wiki/Reverse_DNS_lookup</a><br/> <a href="http://blog.chinaunix.net/u1/41559/showart_2305245.html" target="_blank">http://blog.chinaunix.net/u1/41559/showart_2305245.html</a></p>
