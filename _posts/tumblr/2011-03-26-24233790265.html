---
layout: post
title: PHP5.3+Apache2+Fastcgi+php-fpm配置
---

<p>写过一篇<a href="/post/24234054638/php5-2-9-apache2-fastcgi-php-fpm" target="_blank">PHP5.2.9+Apache2+Fastcgi+php-fpm配置</a>的文章，当时的PHP版本是5.2.X，现在PHP版本已经升到了PHP5.3.X，有些不适用了，现在重新写一篇：</p>

<h2>1.安装apache2的<a href="http://www.fastcgi.com/dist/mod_fastcgi-current.tar.gz" target="_blank">mod_fastcgi</a></h2>

<pre>tar -zxvf mod_fastcgi

cd mod_fastcgi

cp Makefile.AP2 Makefile

make top_dir=/path/to/apache2#你的apache安装路径

make install

</pre>

<p>编辑httpd.conf 增加如下配置：</p>

<pre>LoadModule fastcgi_module modules/mod_fastcgi.so

</pre>

<h2>2. 安装autoconf2.13</h2>

<p>必须确保已经安装了autoconf2.13，否则在执行以后的&#8221;./buildconf &#8212;force&#8221;命令时候会报错： Forcing buildconf using default Zend directory buildconf: checking installation&#8230; buildconf: autoconf version 2.59 (ok) buildconf: Your version of autoconf likely contains buggy cache code. Running cvsclean for you. To avoid this, install autoconf-2.13.</p>

<pre>wget <a href="http://ftp.gnu.org/gnu/autoconf/autoconf-2.13.tar.gz" target="_blank">http://ftp.gnu.org/gnu/autoconf/autoconf-2.13.tar.gz</a>

tar -zxvf autoconf-2.13.tar.gz

cd autoconf-2.13

./configure --prefix=/path/to/autoconf

make &amp;&amp; make install

export PHP_AUTOCONF=/path/to/autoconf/bin/autoconf

export PHP_AUTOHEADER=/path/to/autoconf/bin/autoheader

</pre>

<h2>3. 安装libevent</h2>

<pre>wget <a href="http://www.monkey.org/~provos/libevent-1.4.13-stable.tar.gz" target="_blank">http://www.monkey.org/~provos/libevent-1.4.13-stable.tar.gz</a>

tar -zxvf libevent-1.4.13-stable.tar.gz

cd libevent-1.4.13-stable/

 ./configure

make &amp;&amp; make install

</pre>

<h2>4. 安装PHP-5.3.2</h2>

<pre>wget <a href="http://cn.php.net/distributions/php-5.3.2.tar.gz" target="_blank">http://cn.php.net/distributions/php-5.3.2.tar.gz</a>

tar -zxvf php-5.3.2.tar.gz

cd php-5.3.2

svn co <a href="http://svn.php.net/repository/php/php-src/branches/PHP_5_3/sapi/fpm" target="_blank">http://svn.php.net/repository/php/php-src/branches/PHP_5_3/sapi/fpm</a> sapi/fpm

 ./buildconf --force

./configure --prefix=/path/to/php5.3.2/ --with-config-file-path=/path/to/php5.3.2/ --enable-fpm --enable-mbstring --enable-xml --enable-fastcgi

make &amp;&amp; make install

</pre>

<h2>5. 启动</h2>

<pre>cd /path/to/php5.3.2/etc/

mv php-fpm.default.conf php-fpm.conf

/path/to/php5.3.2/sbin/php-fpm

</pre>

<p>编辑php-fpm.conf，把下面几行前的注释符号去掉：</p>

<pre>pm.start_servers = 10

pm.min_spare_servers = 10

pm.max_spare_servers = 20

pm.max_requests = 100

</pre>

<h2>6.配置Apache</h2>

<pre>cd /var

mkdir fcgi-bin

cd fcgi-bin

ln -s php-cgi /path/to/php/bin/php #你的php路径，其中要注意权限问题。

</pre>

<p>如果用apache的内部的<a href="http://www.fastcgi.com/mod_fastcgi/docs/mod_fastcgi.html" target="_blank">fpm</a>(fastcgi process manager)，则： 编辑httpd.conf，添加如下配置：</p>

<pre>ScriptAlias /fcgi-bin/ "/var/fcgi-bin/" #定义目录映射

FastCgiServer /var/fcgi-bin/php-cgi -processes 10 #配置fastcgi server，



SetHandler fastcgi-script

Options FollowSymLinks

Order allow,deny

Allow from all



AddType application/x-httpd-php .php  #增加MIME类型

AddHandler php-fastcgi .php          #.php结尾的请求都要用php-fastcgi来处理

Action php-fastcgi /fcgi-bin/php-cgi #设置php-fastcgi的处理器

</pre>

<p>如果用<a href="http://php-fpm.org/CN:Home" target="_blank">php-fpm</a>来管理cgi的话，编辑httpd.conf添加如下配置：</p>

<pre>ScriptAlias /fcgi-bin/ "/var/fcgi-bin/" #定义目录映射

FastCgiExternalServer /var/fcgi-bin/php-cgi -host 127.0.0.1:9000

#配置fastcgi外部server，127.0.0.1:9000地址为php-fpm的监听地址。



SetHandler fastcgi-script

Options FollowSymLinks

Order allow,deny

Allow from all



AddType application/x-httpd-php .php  #增加MIME类型

AddHandler php-fastcgi .php          #.php结尾的请求都要用php-fastcgi来处理

Action php-fastcgi /fcgi-bin/php-cgi #设置php-fastcgi的处理器

</pre>

<p>使用php-fpm是有很多<a href="http://www.yeead.com/archives/shiyongphp-fpmlaipinghuabiangengfastcgimoshixiadephpshezhi" target="_blank">优点</a>的，比如可以平滑地重新加载php.ini文件而不用重启fastcgi进程，对于访问量大的网站来说是很重要的。</p>

<h2>7.重启Apache</h2>

<p>重启Apache,查看phpinfo，如果服务器信息是： Apache/2.2.11 (Unix) mod_fastcgi/2.4.6之类的就说明安装成功了。 如果出现403的错误，查看下/var/fcgi-bin/是否有足够的权限。 ps aux|grep php可以看见N个PHP进程在跑。</p>

<p>参考：<br/> <a href="http://php-fpm.org/wiki/Documentation" target="_blank">http://php-fpm.org/wiki/Documentation</a></p>
