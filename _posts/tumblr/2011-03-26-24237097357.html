---
layout: post
title: HAProxy 配置(日志问题解决)
---

<p>Haproxy是一个负载均衡服务器，能够提供4层，7层代理，并能支持上万级别的 连接，你可以直接在WEB服务器前端加上它，而不影响应用的访问，完全透明。</p>

<h2>1. 安装</h2>

<pre>wget <a href="http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.8.tar.gz" target="_blank">http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.8.tar.gz</a>

tar -zxvf haproxy-1.4.8.tar.gz

cd haproxy-1.4.8

./configure --prefix=/path/to/haproxy

make &amp;&amp; make install

</pre>

<h2>2.配置</h2>

<p>首先要添加haproxy:haproxy用户：</p>

<pre>groupadd haproxy

useradd -g haproxy haproxy

#查看uid和gid

sudo cat /etc/passwd |grep haproxy 

</pre>

<p>编辑haproxy.cfg，添加如下内容：</p>

<pre>global

    log 127.0.0.1   local3

    maxconn 4096            #最大连接数

    chroot /path/to/haproxy #安装目录

    uid 535  #用户haproxy

    gid 520  #组haproxy

    daemon   #守护进程运行

    nbproc 1 #进程数量

    pidfile logs/haproxy.pid

defaults

   log     127.0.0.1       local3

   mode    http       #layer 7代理

   option  httplog

   option  httpclose

   option  dontlognull

   option  forwardfor

   retries 2

   maxconn 2000

   balance roundrobin

   stats   uri     /haproxy-stats

   contimeout      5000

   clitimeout      50000

   srvtimeout      50000



frontend http-in

        bind *:80 #监听地址

        default_backend pool1



backend pool1

        option  httpchk GET /test.php #用来做健康检查

        stats refresh 2

        server server1 192.168.1.1:82 weight 3 maxconn 32 check #check表示对这个server进行健康检查

        server server2 192.168.1.2:82 weight 3 maxconn 32 check

</pre>

<p>查看后端server状态： <a href="http://example.com/haproxy-stats" target="_blank">http://example.com/haproxy-stats</a></p>

<pre>#启动

sudo ./sbin/haproxy -f haproxy.cfg

#重启

sudo ./sbin/haproxy -f haproxy.cfg -st `cat logs/haproxy.pid`

</pre>

<h2>3.日志问题</h2>

<p>有童鞋说日志怎么也写不进去，我也遇到了这个问题，在这里分享下。 编辑/etc/syslog.conf文件，添加：</p>

<pre>local3.*	/var/log/haproxy.log

</pre>

<p>编辑</p>

<pre>/etc/sysconfig/syslog</pre>

<p>文件，把</p>

<p><code>SYSLOGD_OPTIONS="-m 0" </code></p>

<p>改成</p>

<p><code>SYSLOGD_OPTIONS="-r -m 0" #enables logging from remote machines</code></p>

<pre>#重启syslogd:

/etc/init.d/syslog restart 

tail -f -n 30 /var/log/haproxy.log #应该可以看到日志输出了:)

</pre>

<p>参考：<br/> <a href="http://blog.chenlb.com/2009/06/install-haproxy-and-configure-load-balance.html" target="_blank">http://blog.chenlb.com/2009/06/install-haproxy-and-configure-load-balance.html</a><br/> <a href="http://haproxy.1wt.eu/download/1.4/doc/configuration.txt" target="_blank">http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</a></p>
